# Velero Backup Schedule Examples
# Production-grade backup schedules for different use cases and RTO/RPO requirements
# Documentation: https://velero.io/docs/latest/api-types/schedule/

---
# Backup Storage Locations
# Primary location (same region as cluster)
apiVersion: velero.io/v1
kind: BackupStorageLocation
metadata:
  name: primary-us-east-1
  namespace: velero
spec:
  provider: aws
  objectStorage:
    bucket: velero-backups-us-east-1
    prefix: production-cluster
  config:
    region: us-east-1
    s3ForcePathStyle: "false"
    s3Url: ""
    kmsKeyId: ""
    publicUrl: ""
    serverSideEncryption: AES256
    insecureSkipTLSVerify: "false"
  default: true
  accessMode: ReadWrite
  backupSyncPeriod: 1m

---
# Secondary location (different region for DR)
apiVersion: velero.io/v1
kind: BackupStorageLocation
metadata:
  name: secondary-us-west-2
  namespace: velero
spec:
  provider: aws
  objectStorage:
    bucket: velero-backups-us-west-2
    prefix: production-cluster
  config:
    region: us-west-2
    s3ForcePathStyle: "false"
    serverSideEncryption: AES256
  accessMode: ReadWrite
  backupSyncPeriod: 1m

---
# Volume Snapshot Location
apiVersion: velero.io/v1
kind: VolumeSnapshotLocation
metadata:
  name: aws-us-east-1
  namespace: velero
spec:
  provider: aws
  config:
    region: us-east-1

---
# TIER 1: Critical Applications (RTO < 1h, RPO < 5min)
# Frequency: Every 5 minutes
# Retention: 48 hours
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: critical-every-5min
  namespace: velero
  labels:
    tier: critical
    frequency: high
spec:
  schedule: "*/5 * * * *"  # Every 5 minutes
  template:
    # Backup all namespaces with tier=critical label
    labelSelector:
      matchLabels:
        backup-tier: "1"
        environment: production

    # Include cluster-scoped resources
    includeClusterResources: true

    # Enable volume snapshots
    snapshotVolumes: true

    # Volume snapshot locations
    volumeSnapshotLocations:
    - aws-us-east-1

    # Storage location
    storageLocation: primary-us-east-1

    # TTL: 48 hours (frequent backups need shorter retention)
    ttl: 48h

    # Default volumes to restic for incremental backups
    defaultVolumesToRestic: true

    # Exclude resources that don't need backup
    excludedResources:
    - events
    - events.events.k8s.io
    - backups.velero.io
    - restores.velero.io
    - resticrepositories.velero.io

    # Backup hooks for application consistency
    hooks:
      resources:
      # PostgreSQL backup hook
      - name: postgres-critical-backup
        includedNamespaces:
        - "*"
        labelSelector:
          matchLabels:
            app: postgresql
            backup-tier: "1"
        pre:
        - exec:
            command:
            - /bin/bash
            - -c
            - |
              echo "Starting PostgreSQL backup..."
              PGPASSWORD=$POSTGRES_PASSWORD pg_dump \
                -U postgres \
                -h localhost \
                -d $POSTGRES_DB \
                --format=custom \
                --blobs \
                --verbose \
                --file=/backup/dump.backup
              echo "PostgreSQL backup completed"
            container: postgresql
            timeout: 10m
            onError: Fail
        post:
        - exec:
            command:
            - /bin/bash
            - -c
            - rm -f /backup/dump.backup
            container: postgresql

---
# TIER 2: High Priority Applications (RTO < 4h, RPO < 1h)
# Frequency: Hourly
# Retention: 14 days
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: high-priority-hourly
  namespace: velero
  labels:
    tier: high-priority
    frequency: hourly
spec:
  schedule: "0 * * * *"  # Every hour at minute 0
  template:
    labelSelector:
      matchLabels:
        backup-tier: "2"
        environment: production

    includeClusterResources: true
    snapshotVolumes: true
    volumeSnapshotLocations:
    - aws-us-east-1
    storageLocation: primary-us-east-1
    ttl: 336h  # 14 days

    excludedResources:
    - events
    - events.events.k8s.io
    - backups.velero.io
    - restores.velero.io

    hooks:
      resources:
      - name: mysql-backup
        includedNamespaces:
        - "*"
        labelSelector:
          matchLabels:
            app: mysql
            backup-tier: "2"
        pre:
        - exec:
            command:
            - /bin/bash
            - -c
            - |
              mysqldump \
                -u root \
                -p$MYSQL_ROOT_PASSWORD \
                --all-databases \
                --single-transaction \
                --quick \
                --lock-tables=false \
                > /backup/dump.sql
            container: mysql
            timeout: 30m
            onError: Fail

      - name: mongodb-backup
        includedNamespaces:
        - "*"
        labelSelector:
          matchLabels:
            app: mongodb
            backup-tier: "2"
        pre:
        - exec:
            command:
            - /bin/bash
            - -c
            - |
              mongodump \
                --host=localhost:27017 \
                --username=$MONGO_INITDB_ROOT_USERNAME \
                --password=$MONGO_INITDB_ROOT_PASSWORD \
                --authenticationDatabase=admin \
                --out=/backup/dump
            container: mongodb
            timeout: 30m

---
# TIER 3: Standard Applications (RTO < 8h, RPO < 6h)
# Frequency: Every 6 hours
# Retention: 7 days
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: standard-every-6h
  namespace: velero
  labels:
    tier: standard
    frequency: regular
spec:
  schedule: "0 */6 * * *"  # Every 6 hours (00:00, 06:00, 12:00, 18:00)
  template:
    labelSelector:
      matchLabels:
        backup-tier: "3"
        environment: production

    includeClusterResources: true
    snapshotVolumes: true
    volumeSnapshotLocations:
    - aws-us-east-1
    storageLocation: primary-us-east-1
    ttl: 168h  # 7 days

    excludedResources:
    - events
    - events.events.k8s.io

---
# TIER 4: Low Priority / Development (RTO < 24h, RPO < 1d)
# Frequency: Daily
# Retention: 7 days
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: low-priority-daily
  namespace: velero
  labels:
    tier: low-priority
    frequency: daily
spec:
  schedule: "0 3 * * *"  # Daily at 3 AM
  template:
    labelSelector:
      matchLabels:
        backup-tier: "4"

    includeClusterResources: false  # Don't backup cluster resources for dev
    snapshotVolumes: true
    volumeSnapshotLocations:
    - aws-us-east-1
    storageLocation: primary-us-east-1
    ttl: 168h  # 7 days

    excludedResources:
    - events
    - events.events.k8s.io
    - secrets  # Don't backup secrets for dev environments

---
# Full Cluster Backup (All Namespaces)
# Frequency: Daily
# Retention: 30 days
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: full-cluster-daily
  namespace: velero
  labels:
    type: full-cluster
    frequency: daily
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  template:
    # Include all namespaces except system ones
    excludedNamespaces:
    - kube-system
    - kube-public
    - kube-node-lease
    - velero

    includeClusterResources: true
    snapshotVolumes: true
    volumeSnapshotLocations:
    - aws-us-east-1
    storageLocation: primary-us-east-1
    ttl: 720h  # 30 days

    excludedResources:
    - events
    - events.events.k8s.io

---
# Namespace-Specific Backup (Production)
# Frequency: Every 30 minutes
# Retention: 24 hours
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: production-namespace-frequent
  namespace: velero
  labels:
    namespace: production
    frequency: frequent
spec:
  schedule: "*/30 * * * *"  # Every 30 minutes
  template:
    includedNamespaces:
    - production
    - production-database
    - production-cache

    includeClusterResources: false
    snapshotVolumes: true
    volumeSnapshotLocations:
    - aws-us-east-1
    storageLocation: primary-us-east-1
    ttl: 24h

    hooks:
      resources:
      - name: redis-backup
        includedNamespaces:
        - production-cache
        labelSelector:
          matchLabels:
            app: redis
        pre:
        - exec:
            command:
            - /bin/bash
            - -c
            - redis-cli --rdb /data/backup/dump.rdb BGSAVE
            container: redis
            timeout: 5m

---
# Cross-Region Backup (Disaster Recovery)
# Frequency: Every 12 hours
# Retention: 90 days
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: cross-region-dr
  namespace: velero
  labels:
    type: disaster-recovery
    region: multi
spec:
  schedule: "0 */12 * * *"  # Every 12 hours (00:00, 12:00)
  template:
    includedNamespaces:
    - production
    - production-database

    includeClusterResources: true
    snapshotVolumes: false  # Don't duplicate snapshots cross-region
    storageLocation: secondary-us-west-2  # Different region
    ttl: 2160h  # 90 days

    excludedResources:
    - events
    - events.events.k8s.io

---
# StatefulSet Backup (Databases Only)
# Frequency: Every 2 hours
# Retention: 7 days
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: statefulset-databases
  namespace: velero
  labels:
    type: statefulset
    workload: database
spec:
  schedule: "0 */2 * * *"  # Every 2 hours
  template:
    # Only backup StatefulSets
    includedResources:
    - statefulsets
    - persistentvolumeclaims
    - persistentvolumes
    - secrets
    - configmaps

    labelSelector:
      matchLabels:
        stateful: "true"
        type: database

    includeClusterResources: false
    snapshotVolumes: true
    volumeSnapshotLocations:
    - aws-us-east-1
    storageLocation: primary-us-east-1
    ttl: 168h  # 7 days

    hooks:
      resources:
      # PostgreSQL
      - name: postgres-consistent-backup
        includedNamespaces:
        - "*"
        labelSelector:
          matchLabels:
            app: postgresql
        pre:
        - exec:
            command:
            - /bin/bash
            - -c
            - |
              # Checkpoint before backup
              psql -U postgres -c "CHECKPOINT;"
            container: postgresql
            timeout: 1m

      # MySQL
      - name: mysql-consistent-backup
        includedNamespaces:
        - "*"
        labelSelector:
          matchLabels:
            app: mysql
        pre:
        - exec:
            command:
            - /bin/bash
            - -c
            - |
              # Flush tables before backup
              mysql -u root -p$MYSQL_ROOT_PASSWORD -e "FLUSH TABLES WITH READ LOCK;"
            container: mysql
            timeout: 1m
        post:
        - exec:
            command:
            - /bin/bash
            - -c
            - |
              # Unlock tables after backup
              mysql -u root -p$MYSQL_ROOT_PASSWORD -e "UNLOCK TABLES;"
            container: mysql

---
# Monthly Archive Backup
# Frequency: First day of month
# Retention: 1 year
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: monthly-archive
  namespace: velero
  labels:
    type: archive
    frequency: monthly
spec:
  schedule: "0 1 1 * *"  # First day of month at 1 AM
  template:
    includedNamespaces:
    - production
    - production-database

    includeClusterResources: true
    snapshotVolumes: true
    volumeSnapshotLocations:
    - aws-us-east-1
    storageLocation: primary-us-east-1
    ttl: 8760h  # 365 days (1 year)

    excludedResources:
    - events
    - events.events.k8s.io

---
# ConfigMaps and Secrets Backup
# Frequency: Hourly
# Retention: 7 days
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: config-secrets-hourly
  namespace: velero
  labels:
    type: configuration
    frequency: hourly
spec:
  schedule: "30 * * * *"  # Every hour at minute 30
  template:
    # Only backup ConfigMaps and Secrets
    includedResources:
    - configmaps
    - secrets

    includedNamespaces:
    - production
    - staging

    includeClusterResources: false
    snapshotVolumes: false  # No volumes for configs
    storageLocation: primary-us-east-1
    ttl: 168h  # 7 days

---
# PVC-Only Backup (Data Volumes)
# Frequency: Every 4 hours
# Retention: 7 days
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: pvc-only-backup
  namespace: velero
  labels:
    type: data-volumes
    frequency: regular
spec:
  schedule: "0 */4 * * *"  # Every 4 hours
  template:
    # Only backup PVCs and PVs
    includedResources:
    - persistentvolumeclaims
    - persistentvolumes

    labelSelector:
      matchLabels:
        backup-pvc: "true"

    includeClusterResources: false
    snapshotVolumes: true
    volumeSnapshotLocations:
    - aws-us-east-1
    storageLocation: primary-us-east-1
    ttl: 168h  # 7 days

---
# Pre-Production Validation Backup
# Frequency: Before deployments (manual trigger recommended)
# Retention: 48 hours
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: pre-deployment-backup
  namespace: velero
  labels:
    type: pre-deployment
    frequency: on-demand
spec:
  schedule: "0 0 * * 0"  # Weekly on Sunday (placeholder - typically manual)
  paused: true  # Start paused, trigger manually before deployments
  template:
    includedNamespaces:
    - production

    includeClusterResources: true
    snapshotVolumes: true
    volumeSnapshotLocations:
    - aws-us-east-1
    storageLocation: primary-us-east-1
    ttl: 48h

    # Label backups as pre-deployment
    labels:
      velero.io/backup-type: pre-deployment

---
# Compliance Backup (Long-term Retention)
# Frequency: Weekly
# Retention: 2 years
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: compliance-weekly
  namespace: velero
  labels:
    type: compliance
    frequency: weekly
spec:
  schedule: "0 4 * * 0"  # Weekly on Sunday at 4 AM
  template:
    includedNamespaces:
    - production
    - production-database

    includeClusterResources: true
    snapshotVolumes: true
    volumeSnapshotLocations:
    - aws-us-east-1
    storageLocation: secondary-us-west-2  # Store in secondary region
    ttl: 17520h  # 730 days (2 years)

    labels:
      velero.io/backup-type: compliance
      retention-policy: long-term

---
# Selective Application Backup
# Frequency: Every hour
# Retention: 24 hours
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: app-specific-backup
  namespace: velero
  labels:
    app: my-critical-app
    frequency: hourly
spec:
  schedule: "15 * * * *"  # Every hour at minute 15
  template:
    labelSelector:
      matchLabels:
        app: my-critical-app
        environment: production

    includeClusterResources: false
    snapshotVolumes: true
    volumeSnapshotLocations:
    - aws-us-east-1
    storageLocation: primary-us-east-1
    ttl: 24h
