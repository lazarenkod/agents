# Консистентность: шпаргалка

## 1) Модели
- **Strong**: чтение всегда видит последнюю запись. +Просто, –Latency, –Availability (CAP → CP).
- **Bounded Staleness**: задержка чтений ≤ окно. Баланс latency/сильной модели.
- **Read-Your-Writes**: клиент видит свои записи. Требует sticky session/версионирование.
- **Monotonic Reads/Writes**: порядок операций сохраняется для клиента.
- **Eventual**: сходимость со временем. +Высокая доступность/скорость, –Свежесть.
- **Causal**: сохраняет причинность, частичная ордерация, компромисс между strong/eventual.

## 2) CAP/PACELC выбор
| Сеть | Выбор | Комментарий |
|---|---|---|
| Partition? | CP | Жертва доступности, приоритет консистентности (банки, балансировка) |
| Partition? | AP | Жертва консистентности, приоритет доступности (логирование, метрики) |
| No Partition | EL | Выбор latency (локальные чтения) |
| No Partition | EC | Выбор консистентности (глобальные транзакции) |

## 3) Кворумы (N = реплик)
- Чтение/запись: `R + W > N` → strong (при отсутствии сетевого разделения).
- **Треугольник задержек**: увеличение R/W снижает latency другого пути.
- **Гео**: локальные чтения (R=1) + async реплика → eventual; кворум по регионам → latency ↑.

## 4) Шаблон выбора модели
- Транзакционные данные → Strong/Bounded + кворум R/W.
- Телееметрия, логи → Eventual + TTL + дедупликация.
- Соц.ленты → Causal/Read-Your-Writes, фан-аут по очередям.
- Кэш → Eventual, с защитой от thundering herd.

## 5) Контроль и тесты
- Lag budget: целевое отставание репликации.
- Инварианты: уникальность, идемпотентность, монотонность версий.
- Тесты: long-tail consistency, конфликтные записи, clock skew, partition/merge сценарии.
