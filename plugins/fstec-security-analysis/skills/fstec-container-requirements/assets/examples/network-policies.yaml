# –ü—Ä–∏–º–µ—Ä—ã Network Policies –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –§–°–¢–≠–ö (–£–î.5)

# –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –£–î.5: –ö–æ–Ω—Ç—Ä–æ–ª—å —Å–µ—Ç–µ–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏

---
# –ü—Ä–∏–º–µ—Ä 1: Default Deny All (–±–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞ –¥–ª—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π –£–ó)
# –ë–ª–æ–∫–∏—Ä—É–µ—Ç –≤–µ—Å—å ingress –∏ egress —Ç—Ä–∞—Ñ–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: production
  annotations:
    security.fstec/requirement: "–£–î.5"
    security.fstec/description: "–ó–∞–ø—Ä–µ—Ç –≤—Å–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
spec:
  podSelector: {}  # –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –ø–æ–¥–∞–º –≤ namespace
  policyTypes:
  - Ingress
  - Egress
  # –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–≤–∏–ª ingress/egress = –ø–æ–ª–Ω—ã–π –∑–∞–ø—Ä–µ—Ç

---
# –ü—Ä–∏–º–µ—Ä 2: –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: web-app-network-policy
  namespace: production
  annotations:
    security.fstec/requirement: "–£–î.5"
    security.fstec/approved-by: "Security Team"
    security.fstec/approved-date: "2025-11-20"
spec:
  podSelector:
    matchLabels:
      app: web-app
      tier: frontend

  policyTypes:
  - Ingress
  - Egress

  # –í—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫
  ingress:
  # –†–∞–∑—Ä–µ—à–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫ —Ç–æ–ª—å–∫–æ –æ—Ç load balancer
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    - podSelector:
        matchLabels:
          app: nginx-ingress
    ports:
    - protocol: TCP
      port: 8080

  # –ò—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫
  egress:
  # 1. –†–∞–∑—Ä–µ—à–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ backend API
  - to:
    - podSelector:
        matchLabels:
          app: api-backend
          tier: backend
    ports:
    - protocol: TCP
      port: 8000

  # 2. –†–∞–∑—Ä–µ—à–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
  - to:
    - podSelector:
        matchLabels:
          app: postgresql
          tier: database
    ports:
    - protocol: TCP
      port: 5432

  # 3. –†–∞–∑—Ä–µ—à–∏—Ç—å DNS –∑–∞–ø—Ä–æ—Å—ã (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    - podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

---
# –ü—Ä–∏–º–µ—Ä 3: –°—Ç—Ä–æ–≥–∞—è –∏–∑–æ–ª—è—Ü–∏—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–£–ó-1, –£–ó-2)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: classified-data-isolation
  namespace: classified
  annotations:
    security.fstec/requirement: "–£–î.5, –£–î.2"
    security.fstec/classification: "–æ—Å–æ–±–æ–π –≤–∞–∂–Ω–æ—Å—Ç–∏"
    security.fstec/uz-level: "–£–ó-1"
spec:
  podSelector:
    matchLabels:
      security-level: classified
      data-classification: top-secret

  policyTypes:
  - Ingress
  - Egress

  ingress:
  # –†–∞–∑—Ä–µ—à–∏—Ç—å –¢–û–õ–¨–ö–û –æ—Ç –ø–æ–¥–æ–≤ —Å —Ç–∞–∫–∏–º –∂–µ —É—Ä–æ–≤–Ω–µ–º –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
  - from:
    - podSelector:
        matchLabels:
          security-level: classified
          clearance: top-secret
    ports:
    - protocol: TCP
      port: 8443  # –¢–æ–ª—å–∫–æ HTTPS

  egress:
  # –†–∞–∑—Ä–µ—à–∏—Ç—å –¢–û–õ–¨–ö–û –∫ –ø–æ–¥–∞–º –≤ —Ç–æ–º –∂–µ security zone
  - to:
    - namespaceSelector:
        matchLabels:
          security-zone: classified
    - podSelector:
        matchLabels:
          security-level: classified

  # DNS (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# –ü—Ä–∏–º–µ—Ä 4: –ú–∏–∫—Ä–æ—Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è —Ç—Ä–µ—Ö-tier –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# Frontend ‚Üí Backend ‚Üí Database

# 4.1. Frontend Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-netpol
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: frontend

  policyTypes:
  - Ingress
  - Egress

  ingress:
  # –í—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ –æ—Ç ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443

  egress:
  # –¢–æ–ª—å–∫–æ –∫ backend, –ù–ï –Ω–∞–ø—Ä—è–º—É—é –∫ –ë–î
  - to:
    - podSelector:
        matchLabels:
          tier: backend
    ports:
    - protocol: TCP
      port: 8080

  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# 4.2. Backend Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-netpol
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: backend

  policyTypes:
  - Ingress
  - Egress

  ingress:
  # –í—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ –¢–û–õ–¨–ö–û –æ—Ç frontend
  - from:
    - podSelector:
        matchLabels:
          tier: frontend
    ports:
    - protocol: TCP
      port: 8080

  egress:
  # –¢–æ–ª—å–∫–æ –∫ database
  - to:
    - podSelector:
        matchLabels:
          tier: database
    ports:
    - protocol: TCP
      port: 5432

  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

  # –í–Ω–µ—à–Ω–∏–µ API (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
    # –ú–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø–æ CIDR:
    # to:
    # - ipBlock:
    #     cidr: 10.0.0.0/8  # –¢–æ–ª—å–∫–æ internal network

---
# 4.3. Database Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: database-netpol
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: database

  policyTypes:
  - Ingress
  - Egress

  ingress:
  # –í—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ –¢–û–õ–¨–ö–û –æ—Ç backend
  - from:
    - podSelector:
        matchLabels:
          tier: backend
    ports:
    - protocol: TCP
      port: 5432

  egress:
  # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ù–ï –¥–æ–ª–∂–Ω–∞ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ö–æ–¥—è—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  # –†–∞–∑—Ä–µ—à–∏—Ç—å –¢–û–õ–¨–ö–û DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# –ü—Ä–∏–º–µ—Ä 5: –ò–∑–æ–ª—è—Ü–∏—è namespaces (–º–µ–∂–ø—Ä–æ–µ–∫—Ç–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-other-namespaces
  namespace: team-a
spec:
  podSelector: {}  # –í—Å–µ –ø–æ–¥—ã –≤ namespace

  policyTypes:
  - Ingress
  - Egress

  ingress:
  # –†–∞–∑—Ä–µ—à–∏—Ç—å –¢–û–õ–¨–ö–û –æ—Ç –ø–æ–¥–æ–≤ –≤ —Ç–æ–º –∂–µ namespace
  - from:
    - podSelector: {}

  egress:
  # –†–∞–∑—Ä–µ—à–∏—Ç—å –¢–û–õ–¨–ö–û –∫ –ø–æ–¥–∞–º –≤ —Ç–æ–º –∂–µ namespace
  - to:
    - podSelector: {}

  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# –ü—Ä–∏–º–µ—Ä 6: –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞ –ø–æ IP CIDR (–≤–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-external-api
  namespace: production
spec:
  podSelector:
    matchLabels:
      app: integration-service

  policyTypes:
  - Egress

  egress:
  # –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –≤–Ω–µ—à–Ω–µ–º—É API
  - to:
    - ipBlock:
        cidr: 203.0.113.0/24  # External API CIDR
        except:
        - 203.0.113.5/32      # –ò—Å–∫–ª—é—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π IP
    ports:
    - protocol: TCP
      port: 443

  # –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º —Å–µ—Ç—è–º
  # (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø—Ä–µ—â–µ–Ω–æ, –Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏)
  # –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è:
  # - 10.0.0.0/8
  # - 172.16.0.0/12
  # - 192.168.0.0/16

---
# –ü—Ä–∏–º–µ—Ä 7: Monitoring –∏ Logging –∏—Å–∫–ª—é—á–µ–Ω–∏—è
# Prometheus –∏ FluentBit –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫/–ª–æ–≥–æ–≤
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-monitoring
  namespace: production
spec:
  podSelector: {}  # –í—Å–µ –ø–æ–¥—ã

  policyTypes:
  - Ingress

  ingress:
  # –†–∞–∑—Ä–µ—à–∏—Ç—å Prometheus scraping
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9090  # Metrics port

  # –†–∞–∑—Ä–µ—à–∏—Ç—å FluentBit –¥–ª—è –ª–æ–≥–æ–≤ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è daemonset)
  - from:
    - namespaceSelector:
        matchLabels:
          name: logging
    - podSelector:
        matchLabels:
          app: fluent-bit

---
# –ü—Ä–∏–º–µ—Ä 8: Service Mesh integration (Istio/Linkerd)
# –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ service mesh –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Ä—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-service-mesh
  namespace: production
spec:
  podSelector: {}

  policyTypes:
  - Ingress
  - Egress

  ingress:
  # –†–∞–∑—Ä–µ—à–∏—Ç—å Envoy sidecar intercept
  - from:
    - podSelector: {}  # –û—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–¥–æ–≤ –≤ namespace
    ports:
    - protocol: TCP
      port: 15001  # Envoy inbound
    - protocol: TCP
      port: 15006  # Envoy inbound (HTTP)

  egress:
  # –†–∞–∑—Ä–µ—à–∏—Ç—å Envoy sidecar egress
  - to:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 15001

  # Control plane communication
  - to:
    - namespaceSelector:
        matchLabels:
          name: istio-system
    ports:
    - protocol: TCP
      port: 15012  # XDS

---
# –ü—Ä–∏–º–µ—Ä 9: –í—Ä–µ–º–µ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è debugging (–ù–ï –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞!)
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û –¥–ª—è troubleshooting, –∑–∞—Ç–µ–º —É–¥–∞–ª–∏—Ç—å!
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: debug-allow-all
  namespace: development
  annotations:
    security.fstec/temporary: "true"
    security.fstec/expires: "2025-11-30"
    security.fstec/approved-by: "DevOps Team"
    security.fstec/reason: "Debugging network connectivity issues"
spec:
  podSelector:
    matchLabels:
      debug: "true"  # –¢–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–æ–≤ —Å —ç—Ç–∏–º label

  policyTypes:
  - Ingress
  - Egress

  ingress:
  - {}  # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤–µ—Å—å ingress

  egress:
  - {}  # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤–µ—Å—å egress

---
# –ü—Ä–∏–º–µ—Ä 10: Deny egress to metadata service (–∑–∞—â–∏—Ç–∞ –æ—Ç SSRF)
# –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ cloud metadata endpoints
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-metadata-service
  namespace: production
  annotations:
    security.fstec/requirement: "–ó–¢–°.1"
    security.fstec/description: "–ó–∞—â–∏—Ç–∞ –æ—Ç SSRF –∞—Ç–∞–∫ –Ω–∞ metadata service"
spec:
  podSelector: {}

  policyTypes:
  - Egress

  egress:
  # –Ø–≤–Ω–æ –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ metadata endpoints
  # AWS metadata
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
        except:
        - 169.254.169.254/32
        - 169.254.0.0/16  # Link-local

  # GCP metadata
  # - metadata.google.internal –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ DNS policy

  # Azure metadata (168.63.129.16) –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ

---
# –ß–µ–∫-–ª–∏—Å—Ç Network Policies –¥–ª—è –§–°–¢–≠–ö:

# ‚úÖ –£–î.5 - –ö–æ–Ω—Ç—Ä–æ–ª—å —Å–µ—Ç–µ–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
# 1. [x] Default deny –ø–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è –≤—Å–µ—Ö namespaces
# 2. [x] –Ø–≤–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞
# 3. [x] –ú–∏–∫—Ä–æ—Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è (tier isolation)
# 4. [x] Namespace isolation
# 5. [x] –ó–∞—â–∏—Ç–∞ –ë–î (—Ç–æ–ª—å–∫–æ –æ—Ç backend)
# 6. [x] DNS —Ä–∞–∑—Ä–µ—à–µ–Ω (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã)
# 7. [x] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø
# 8. [x] Metadata service –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
# 9. [x] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
# 10. [x] –†–µ–≥—É–ª—è—Ä–Ω—ã–π –∞—É–¥–∏—Ç –ø—Ä–∞–≤–∏–ª

# ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è:
# - –í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏
# - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å labels –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–¥–æ–≤
# - –ù–µ –∑–∞–±—ã–≤–∞—Ç—å –ø—Ä–æ DNS (–∏–Ω–∞—á–µ –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!)
# - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
# - –†–µ–≥—É–ª—è—Ä–Ω–æ –ø–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞
# - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å monitoring –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–µ–≥–∏—Ç–∏–º–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞

# üìù –í–∞–ª–∏–¥–∞—Ü–∏—è NetworkPolicy:
# kubectl describe networkpolicy <name> -n <namespace>
# kubectl get networkpolicies --all-namespaces
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: network-policy-viewer, Cilium network policy editor
